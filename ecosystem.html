<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BR Citizen Labs — Ecosystem</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/venn.js"></script>

<style>

body {
    margin: 0;
    padding: 0;
    font-family: 'Courier New', 'Lucida Console', Monaco, Monospace;
    background-color: #808000;
    color: white;
}

header {
    background-color: #ffffff;
    color: black;
    padding: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border-radius: 15px;
    margin: 20px;
}

.header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.header-content h1 {
    margin: 0;
    font-size: 1.8rem;
    text-align: center;
}

header h2 {
    color: #4b54a3;
    text-align: center;
    font-size: 1rem;
    font-weight: 400;
    top-margin: 0;
}

.large-left-btn {
    width: 70px;
    height: 70px;
    background-color: white;
    border: 3px solid black;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background-color 0.2s;
}

.large-left-btn img {
    width: 80%;
    height: 80%;
    object-fit: contain;
}

.large-left-btn:hover {
    transform: scale(1.05);
    background-color: #eee;
}

.button-container {
    display: flex;
    gap: 10px;
}

.round-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid black;
    overflow: hidden;
    background-color: #ffffff;
    transition: transform 0.2s;
}

.round-btn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.round-btn:hover {
    transform: scale(1.1);
}

.page-menu {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 10px 10px;
}

.page-menu a {
    padding: 8px 14px;
    border: 2px solid transparent;
    color: white;
    text-decoration: none;
    font-family: inherit;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: 0.15s;
}

.page-menu a:hover {
    transform: scale(1.05);
}

body[data-page="ecosystem"] .page-menu a[data-page="ecosystem"],
body[data-page="geolocation"] .page-menu a[data-page="geolocation"],
body[data-page="analysis"] .page-menu a[data-page="analysis"] {
    border-color: white;
}

#main-content {
    margin: 0 20px 30px 20px;
    border-radius: 15px;
    padding: 20px;
    background: rgba(0,0,0,0.12);
}

/* 2. ESTILOS CSS PARA LA VISUALIZACIÓN */
#venn-diagram-svg-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 20px;
}

/* Estilo de los círculos de la librería Venn.js */
.venn-area {
    fill-opacity: 0.6;
    stroke: #fff;
    stroke-width: 2px;
    transition: fill-opacity 0.2s;
}

/* Estilo de los puntos (dots) */
.lab-dot {
    stroke: none;
    transition: opacity 0.3s;
    cursor: pointer;
}

@media(min-width: 768px) {
    .header-content { flex-direction: row; justify-content: space-between; align-items: center; }
    .header-content h1 { font-size: 2rem; }
    .page-menu { justify-content: flex-start; margin-left: 20px; }
}
</style>
</head>
<body class="ecosystem" data-page="ecosystem">

<header>
    <div class="header-content">
        <a href="https://drive.google.com/file/d/1XaMD08p6vzy4FUFhi-qIKKLY2gouoTua/view?usp=sharing" target="_blank" class="large-left-btn">
            <img src="Documentlogo.png" alt="Home Link Icon">
        </a>

        <h1>Brazilian Citizen Labs</h1>

        <div class="button-container">
            <a href="https://br.linkedin.com/in/valentina-melgar-bermúdez-a9b3712b8" target="_blank" class="round-btn">
                <img src="LinkedInlogo.png" alt="LinkedIn">
            </a>
            <a href="https://tinahmb.substack.com/" target="_blank" class="round-btn">
                <img src="Substacklogo.png" alt="Substack">
            </a>
        </div>
    </div>

    <h2>by Valentina Melgar Bermúdez</h2>
</header>

<nav class="page-menu" aria-label="Site pages">
    <a href="index.html" data-page="geolocation">Geolocation</a>
    <a href="ecosystem.html" data-page="ecosystem">Ecosystem</a>
    <a href="analysis.html" data-page="analysis">Analysis</a>
</nav>

<div id="main-content">
    <p>Haz clic en las áreas del diagrama para filtrar.</p>
    
    <div id="venn-diagram-svg-wrapper"></div>
</div>

<script>
    
    // --- IMPORTANTE: REEMPLAZAR ESTO ---
    // *** DEBES REEMPLAZAR el contenido de LAB_STRUCTURE_DATA con el JSON COMPLETO ***
    // *** que descargaste del archivo 'lab_structure.json'. ***
    // (Este es solo un placeholder basado en el preview)
    const LAB_STRUCTURE_DATA = {
        "Civiles": {
            "coords": { "cx": 200, "cy": 150, "r": 80, "name": "Solo Civiles" },
            "affiliation_groups": { /* Pegar aquí tus datos reales */ }
        },
        "Educacionales": {
            "coords": { "cx": 350, "cy": 150, "r": 80, "name": "Solo Educacionales" },
            "affiliation_groups": { /* ... */ }
        },
        "Gubernamentales": {
            "coords": { "cx": 275, "cy": 250, "r": 80, "name": "Solo Gubernamentales" },
            "affiliation_groups": { /* ... */ }
        },
        "Civiles/Educacionales": {
            "coords": { "cx": 275, "cy": 120, "r": 40, "name": "C ∩ E" },
            "affiliation_groups": { /* ... */ }
        },
        "Civiles/Gubernamentales": {
            "coords": { "cx": 230, "cy": 200, "r": 40, "name": "C ∩ G" },
            "affiliation_groups": { /* ... */ }
        },
        "Educacionales/Gubernamentales": {
            "coords": { "cx": 320, "cy": 200, "r": 40, "name": "E ∩ G" },
            "affiliation_groups": { /* ... */ }
        },
        "Triple": {
            "coords": { "cx": 275, "cy": 170, "r": 30, "name": "C ∩ E ∩ G" },
            "affiliation_groups": { /* ... */ }
        }
    };
    
    // --- VENN.JS DATA (Tamaños de las áreas) ---
    // *** AJUSTA ESTOS TAMAÑOS con los conteos reales de tu base de datos ***
    const ecosystemData = [
        {sets: ['Civiles'], size: 84, label: 'Sociedad Civil (C)', color: '#1b9e77'},
        {sets: ['Educacionales'], size: 54, label: 'Educacional (E)', color: '#d95f02'},
        {sets: ['Gubernamentales'], size: 40, label: 'Gubernamental (G)', color: '#7570b3'},
        
        // Intersecciones (debes calcular la suma de labs en cada intersección)
        {sets: ['Civiles', 'Educacionales'], size: 20},
        {sets: ['Civiles', 'Gubernamentales'], size: 15},
        {sets: ['Educacionales', 'Gubernamentales'], size: 12},
        {sets: ['Civiles', 'Educacionales', 'Gubernamentales'], size: 5}
    ];

    // --- CONFIGURACIÓN Y FUNCIONES AUXILIARES ---
    
    // Mapeo de Colores (AJUSTAR: Añade todas tus Afiliaciones aquí)
    const AFFILIATION_COLORS = {
        "Universidad Federal ABC (UFABC)": "#4B54A3", 
        "Asociación civil u ONG": "#F39C12", 
        "Independiente": "#27AE60",
        "None": "#606060", // Color para agrupaciones sin afiliación específica
        "Firjan/SENAI": "#D8234B",
        // ... añade el resto de tus afiliaciones
    };

    function getColorByAffiliation(d) {
        return AFFILIATION_COLORS[d.affiliation] || "#888888"; 
    }
    
    const DOT_RADIUS = 3;
    const SPREAD_FACTOR = 0.8; 

    // Función de Posicionamiento Aleatorio (Geometry)
    function getRandomPositionInCircle(centerX, centerY, radius) {
        const angle = Math.random() * 2 * Math.PI;
        const radius_sq = Math.random() * radius * radius;
        const r_rand = Math.sqrt(radius_sq); 

        return {
            x: centerX + r_rand * Math.cos(angle),
            y: centerY + r_rand * Math.sin(angle)
        };
    }

    // --- 5. FUNCIÓN DE DIBUJO DEL DIAGRAMA DE VENN ---
    function drawVennDiagram(sets) {
        const chart = venn.VennDiagram()
            .width(600)
            .height(400);

        d3.select("#venn-diagram-svg-wrapper")
            .datum(sets)
            .call(chart)
            .select("svg")
            .attr("viewBox", "0 0 600 400"); // Asegura que el SVG sea responsivo

        // Añadir evento de click a las áreas
        d3.selectAll("#venn-diagram-svg-wrapper .venn-area")
            .on("click", function(event, d) {
                // Genera el nombre de la intersección/set para el filtro
                const filter = d.sets.map(s => s.label).join('/');
                applyFilter(filter);
            });
            
        // Etiqueta 'All' para resetear
        d3.select("#venn-diagram-svg-wrapper svg")
            .append("text")
            .attr("x", 50)
            .attr("y", 50)
            .attr("fill", "white")
            .attr("cursor", "pointer")
            .text("Mostrar Todo (171)")
            .on("click", () => applyFilter('all'));
    }

    // --- 6. FUNCIÓN DE DIBUJO DE PUNTOS (DOT PLOT) ---
    function drawDots(dataStructure) {
        const svg = d3.select("#venn-diagram-svg-wrapper svg");
        svg.selectAll(".dot-container").remove(); // Limpiar contenedor de puntos
        
        const dotGroup = svg.append("g").attr("class", "dot-container");
        let allDots = [];

        // Iterar sobre las 7 regiones
        Object.keys(dataStructure).forEach(regionKey => {
            const regionData = dataStructure[regionKey];
            const { cx, cy, r } = regionData.coords; 
            
            // Iterar sobre los grupos de Afilicación
            Object.keys(regionData.affiliation_groups).forEach(affiliationKey => {
                const affiliationGroup = regionData.affiliation_groups[affiliationKey];
                
                // Iterar sobre los Subgrupos de Red
                Object.keys(affiliationGroup.network_subgroups).forEach(networkKey => {
                    const labCount = affiliationGroup.network_subgroups[networkKey].lab_count;

                    for (let i = 0; i < labCount; i++) {
                        const position = getRandomPositionInCircle(cx, cy, r * SPREAD_FACTOR); 
                        
                        allDots.push({
                            x: position.x,
                            y: position.y,
                            region: regionKey,
                            affiliation: affiliationKey,
                            network: networkKey,
                            id: `${regionKey}-${affiliationKey}-${i}` 
                        });
                    }
                });
            });
        });

        // Dibujar los círculos SVG
        dotGroup.selectAll(".lab-dot")
            .data(allDots)
            .enter()
            .append("circle")
            .attr("class", "lab-dot")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 0) // Empezar con radio 0 para animación
            .attr("fill", getColorByAffiliation) 
            .attr("opacity", 0.8)
            .transition()
            .duration(500)
            .attr("r", DOT_RADIUS); // Animación de aparición
            
        console.log(`Total de ${allDots.length} puntos dibujados.`);
    }

    // --- 7. FUNCIÓN DE FILTRADO (INTERACCIÓN) ---
    function applyFilter(filter) {
        // 1. Manejar el resaltado de las áreas del Venn (solo opacidad)
        d3.selectAll("#venn-diagram-svg-wrapper .venn-area")
            .transition()
            .duration(300)
            .attr("fill-opacity", function(d) {
                const areaName = d.sets.map(s => s.label).join('/');
                if (filter === 'all' || areaName === filter) {
                    return 0.6; // Opacidad normal
                }
                return 0.1; // Desvanecer otras áreas
            });

        // 2. Manejar el resaltado de los puntos (dots)
        d3.selectAll(".lab-dot")
            .transition()
            .duration(300)
            .attr("opacity", function(d) {
                // La lógica del filtro debe coincidir con la REGION (la clave del JSON)
                if (filter === 'all' || d.region === filter) {
                    return 0.8;
                }
                return 0.1; 
            });
    }

    // --- EJECUCIÓN INICIAL ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Dibuja el Venn (las áreas)
        drawVennDiagram(ecosystemData); 
        
        // 2. Dibuja los puntos (dots)
        drawDots(LAB_STRUCTURE_DATA);
        
        // 3. Establece el filtro inicial
        applyFilter('all');
    });

</script>

</body>
</html>
