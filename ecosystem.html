<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BR Citizen Labs — Ecosystem</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/venn.js"></script>

<style>

body {
    margin: 0;
    padding: 0;
    font-family: 'Courier New', 'Lucida Console', Monaco, Monospace;
    background-color: #808000;
    color: white;
}

header {
    background-color: #ffffff;
    color: black;
    padding: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border-radius: 15px;
    margin: 20px;
}

.header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.header-content h1 {
    margin: 0;
    font-size: 1.8rem;
    text-align: center;
}

header h2 {
    color: #4b54a3;
    text-align: center;
    font-size: 1rem;
    font-weight: 400;
    top-margin: 0;
}

.large-left-btn {
    width: 70px;
    height: 70px;
    background-color: white;
    border: 3px solid black;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background-color 0.2s;
}

.large-left-btn img {
    width: 80%;
    height: 80%;
    object-fit: contain;
}

.large-left-btn:hover {
    transform: scale(1.05);
    background-color: #eee;
}

.button-container {
    display: flex;
    gap: 10px;
}

.round-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid black;
    overflow: hidden;
    background-color: #ffffff;
    transition: transform 0.2s;
}

.round-btn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.round-btn:hover {
    transform: scale(1.1);
}

.page-menu {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 10px 10px;
}

.page-menu a {
    padding: 8px 14px;
    border: 2px solid transparent;
    color: white;
    text-decoration: none;
    font-family: inherit;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: 0.15s;
}

.page-menu a:hover {
    transform: scale(1.05);
}

body[data-page="ecosystem"] .page-menu a[data-page="ecosystem"],
body[data-page="geolocation"] .page-menu a[data-page="geolocation"],
body[data-page="analysis"] .page-menu a[data-page="analysis"] {
    border-color: white;
}

#main-content {
    margin: 0 20px 30px 20px;
    border-radius: 15px;
    padding: 20px;
    background: #384045; 
}

/* 2. ESTILOS CSS PARA LA VISUALIZACIÓN */
#venn-diagram-svg-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 20px;
}

/* Estilo de los círculos de la librería Venn.js */
.venn-area {
    fill-opacity: 0.6;
    stroke: #fff;
    stroke-width: 2px;
    transition: fill-opacity 0.2s;
}

/* Estilo de los puntos (dots) */
.lab-dot {
    stroke: none;
    transition: opacity 0.3s;
    cursor: pointer;
}

@media(min-width: 768px) {
    .header-content { flex-direction: row; justify-content: center; align-items: center; }
    .header-content h1 { font-size: 2rem; }
    .page-menu { justify-content: center; margin-left: 20px; }
}
</style>
</head>
<body class="ecosystem" data-page="ecosystem">

<header>
    <div class="header-content">
        <a href="https://drive.google.com/file/d/1XaMD08p6vzy4FUFhi-qIKKLY2gouoTua/view?usp=sharing" target="_blank" class="large-left-btn">
            <img src="Documentlogo.png" alt="Thesis">
        </a>

        <h1>Brazilian Citizen Labs</h1>

        <div class="button-container">
            <a href="https://br.linkedin.com/in/valentina-melgar-bermúdez-a9b3712b8" target="_blank" class="round-btn">
                <img src="LinkedInlogo.png" alt="LinkedIn">
            </a>
            <a href="https://tinahmb.substack.com/" target="_blank" class="round-btn">
                <img src="Substacklogo.png" alt="Substack">
            </a>
        </div>
    </div>

    <h2>by Valentina Melgar Bermúdez</h2>
</header>

<nav class="page-menu" aria-label="Site pages">
    <a href="index.html" data-page="geolocation">Geolocation</a>
    <a href="ecosystem.html" data-page="ecosystem">Ecosystem</a>
    <a href="analysis.html" data-page="analysis">Analysis</a>
</nav>

<div id="main-content">
    <p>Labs by Tag:</p>
    
    <div id="venn-diagram-svg-wrapper"></div>
</div>

<script>
    
    const LAB_STRUCTURE_DATA = {
    "Civiles": {
        "coords": {
            "cx": 200,
            "cy": 150,
            "r": 80,
            "name": "Solo Civiles"
        },
        "affiliation_groups": {
            "Firjan/SENAI": {
                "total_labs": 11,
                "network_subgroups": {
                    "Federacao das Induastrias do Estado do Rio de Janeiro Firja/SENAI (Servicio Nacional de Aprendizaje Industrial)": {
                        "lab_count": 11
                    },
                }
            },
            "Grupo Tiradentes": {
                "total_labs": 1,
                "network_subgroups": {
                    "Tiradentes Innovation Center": {
                        "lab_count": 1
                    }
                }
            },
            "Movimento +Social Good": {
                "total_labs": 1,
                "network_subgroups": {
                    "Fundacao das Nações Unidas": {
                        "lab_count": 1
                    }
                }
            },
            "None": {
                "total_labs": 45,
                "network_subgroups": {
                    "Agencia Kerno": {
                        "lab_count": 1
                    },
                    "Caravana Digital SIP": {
                        "lab_count": 1
                    },
                    "Fora do Eixo": {
                        "lab_count": 1
                    },
                    "Grupo de Assessoria de Mobilizão de Talentos (GAMT)": {
                        "lab_count": 1
                    },
                    "Lab Maker Living Lab": {
                        "lab_count": 1
                    },
                    "Machado Meyer Advogados": {
                        "lab_count": 1
                    },
                    "Makers Manaus": {
                        "lab_count": 1
                    },
                    "Midia Ninja": {
                        "lab_count": 1
                    },
                    "None": {
                        "lab_count": 32
                    },
                    "O nosso papel ONG": {
                        "lab_count": 1
                    },
                    "Parque Tecnologico de Sorocaba": {
                        "lab_count": 1
                    },
                    "Parque de Desarrollo Tecnologico (PADETEC)": {
                        "lab_count": 1
                    },
                    "SHC - Santos Hacker Clube": {
                        "lab_count": 1
                    },
                    "Servicos Brasileiro de Apoio as Micro e Pequenas Empresas de Mato Grosso do Sul (SEBRAE MS)": {
                        "lab_count": 1
                    }
                }
            },
            "SENAI": {
                "total_labs": 2,
                "network_subgroups": {
                    "Federacao das Industrias do Estado de Minas Gerais (FIEMG)": {
                        "lab_count": 1
                    },
                    "Servicio Nacional de Aprendizaje Industrial (SENAI)": {
                        "lab_count": 1
                    }
                }
            },
            "Sistema Federacion de las industrias del Estado de Parana (FIEP)": {
                "total_labs": 2,
                "network_subgroups": {
                    "SESI/SENAI/Instituto Euvaldo Lodi (IEL)": {
                        "lab_count": 2
                    }
                }
            }
        }
    },
    "Civiles/Educacionales": {
        "coords": {
            "cx": 275,
            "cy": 120,
            "r": 40,
            "name": "CE"
        },
        "affiliation_groups": {
            "Escola SESI": {
                "total_labs": 30,
                "network_subgroups": {
                    "Servicio Social de la Industria (SESI)": {
                        "lab_count": 30
                    }
                }
            },
            "None": {
                "total_labs": 1,
                "network_subgroups": {
                    "Fundacao Helena Antipoff": {
                        "lab_count": 1
                    }
                }
            }
        }
    },
    "Civiles/Educacionales/Gubernamentales": {
        "coords": {
            "cx": 50,
            "cy": 50,
            "r": 50
        },
        "affiliation_groups": {
            "None": {
                "total_labs": 2,
                "network_subgroups": {
                    "SENAI/Universidad Federal de Goias": {
                        "lab_count": 1
                    },
                    "Universidad Estatal de Mato Grosso do Sul (UEMS)/SENAI": {
                        "lab_count": 1
                    }
                }
            }
        }
    },
    "Civiles/Gubernamentales": {
        "coords": {
            "cx": 230,
            "cy": 200,
            "r": 40,
            "name": "CG"
        },
        "affiliation_groups": {
            "FAB LAB LIVRE SP": {
                "total_labs": 13,
                "network_subgroups": {
                    "Pefectura Municipal SP/Instituto de Tecnologia Social (ITS) BRASIL": {
                        "lab_count": 13
                    }
                }
            }
        }
    },
    "Educacionales": {
        "coords": {
            "cx": 350,
            "cy": 150,
            "r": 80,
            "name": "Solo Educacionales"
        },
        "affiliation_groups": {
            "Amadomaker": {
                "total_labs": 1,
                "network_subgroups": {
                    "Universidad de Passo Fundo (UPF)": {
                        "lab_count": 1
                    }
                }
            },
            "American Spaces": {
                "total_labs": 2,
                "network_subgroups": {
                    "ABA": {
                        "lab_count": 1
                    },
                    "Casa Thomas Jefferson/Departamento de Estado de EUA": {
                        "lab_count": 1
                    }
                }
            },
            "Escola Concept": {
                "total_labs": 3,
                "network_subgroups": {
                    "Escola Concept": {
                        "lab_count": 3
                    }
                }
            },
            "Fablab Maua": {
                "total_labs": 2,
                "network_subgroups": {
                    "Instituto Maua de Tecnologia": {
                        "lab_count": 2
                    }
                }
            },
            "Facens": {
                "total_labs": 2,
                "network_subgroups": {
                    "Faculdade de Engenharia de Sorocaba (Facens)": {
                        "lab_count": 2
                    }
                }
            },
            "None": {
                "total_labs": 13,
                "network_subgroups": {
                    "Centro Universitario Paraiso (UniFAP)": {
                        "lab_count": 1
                    },
                    "Centro Universitario de Excelencia en Guarulhos (ENIAC)": {
                        "lab_count": 1
                    },
                    "Centro universitario de Patos de Minas (Unipam)": {
                        "lab_count": 1
                    },
                    "Escola Castanheiras": {
                        "lab_count": 1
                    },
                    "Fundação Torino": {
                        "lab_count": 1
                    },
                    "Newton": {
                        "lab_count": 1
                    },
                    "Pontificia Universidad Católica de Rio Grande del Sur (PUCRS)": {
                        "lab_count": 1
                    },
                    "Sinergia": {
                        "lab_count": 1
                    },
                    "Universidad de Araraquara (Uniara)": {
                        "lab_count": 1
                    },
                    "Universidad de Vale do Rio dos Sinos (Unisinos)": {
                        "lab_count": 1
                    },
                    "Universidad de la Salle (Unilasalle)": {
                        "lab_count": 1
                    },
                    "Universidade Paulista (UNIP)": {
                        "lab_count": 1
                    },
                    "Universidade Presbiteriana Mackenzie": {
                        "lab_count": 1
                    }
                }
            },
            "Pronto3D": {
                "total_labs": 1,
                "network_subgroups": {
                    "Universidad Comunitaria de la región de Chapecó (Unochapecó)": {
                        "lab_count": 1
                    }
                }
            },
            "Ánima Lab": {
                "total_labs": 2,
                "network_subgroups": {
                    "Centro Universitario de Belo Horizonte (UniBH)": {
                        "lab_count": 1
                    },
                    "São Judas Unimonte": {
                        "lab_count": 1
                    }
                }
            }
        }
    },
    "Educacionales/Gubernamentales": {
        "coords": {
            "cx": 320,
            "cy": 200,
            "r": 40,
            "name": "EG"
        },
        "affiliation_groups": {
            "Amadomaker": {
                "total_labs": 1,
                "network_subgroups": {
                    "Prefectura Municipal de Passo Fundo/Escuela de las profesiones": {
                        "lab_count": 1
                    }
                }
            },
            "Enactus": {
                "total_labs": 1,
                "network_subgroups": {
                    "Universidade Federal do Rio de Janeiro (UFRJ)": {
                        "lab_count": 1
                    }
                }
            },
            "IFMaker": {
                "total_labs": 1,
                "network_subgroups": {
                    "Instituto Federal de Tocantins (IFTO)": {
                        "lab_count": 1
                    }
                }
            },
            "Lablivre/Wikilab": {
                "total_labs": 1,
                "network_subgroups": {
                    "Universidad Federal ABC (UFABC)": {
                        "lab_count": 1
                    }
                }
            },
            "None": {
                "total_labs": 23,
                "network_subgroups": {
                    "\"Instituto Estadual de Educación": {
                        "lab_count": 1
                    },
                    "\"Instituto Federal de Educación": {
                        "lab_count": 3
                    },
                    "\"Instituto Federal de Educación": {
                        "lab_count": 1
                    },
                    "Centro de Tecnologia Académica do Instituto de Física (CTA IF)/Universidad Federal de Rio Grande do Sul": {
                        "lab_count": 1
                    },
                    "Escola Municipal de Ensino Fundamental Doutor Paulo da Silva Couto": {
                        "lab_count": 1
                    },
                    "Faculdade de Tecnologia de Araraquara (Fatec Arq)-Centro Paula Souza": {
                        "lab_count": 1
                    },
                    "Instituto Anísio Teixeira": {
                        "lab_count": 1
                    },
                    "Instituto de Física de la Universidad de SP (IFUSP)": {
                        "lab_count": 1
                    },
                    "Universidad Estatal de Campinas (UNICAMP)": {
                        "lab_count": 1
                    },
                    "Universidad Federal de Mato Grosso (UFMG)": {
                        "lab_count": 1
                    },
                    "Universidad Federal de Mato Grosso (UFMT)": {
                        "lab_count": 1
                    },
                    "Universidad Federal de Paraíba (UFPB)": {
                        "lab_count": 1
                    },
                    "Universidad Federal de Rio Grande do Sur (UFRGS)": {
                        "lab_count": 1
                    },
                    "Universidad Federal de Rio Grande del Sur": {
                        "lab_count": 1
                    },
                    "Universidad Federal de Santa Catarina (UFSC)": {
                        "lab_count": 1
                    },
                    "Universidad Federal de São Carlos (UFSCar)": {
                        "lab_count": 1
                    },
                    "Universidad Federal del Oeste de Bahia (UFOB)": {
                        "lab_count": 1
                    },
                    "Universidad de Blumenau (FURB)": {
                        "lab_count": 1
                    },
                    "Universidade Estadual Paulista (UNESP)/Sagui lab": {
                        "lab_count": 1
                    },
                    "Universidade Federal do Piauí (UFPI)": {
                        "lab_count": 1
                    },
                    "Universidade Federal do Rio de Janeiro (UFRJ)": {
                        "lab_count": 1
                    }
                }
            },
            "Pronto3D": {
                "total_labs": 1,
                "network_subgroups": {
                    "Universidad Federal de Santa Catarina (UFSC)": {
                        "lab_count": 1
                    }
                }
            }
        }
    },
    "Gubernamentales": {
        "coords": {
            "cx": 275,
            "cy": 250,
            "r": 80,
            "name": "Solo Gubernamentales"
        },
        "affiliation_groups": {
            "None": {
                "total_labs": 9,
                "network_subgroups": {
                    "Cámara de Diputados Federal": {
                        "lab_count": 1
                    },
                    "Ministerio de cuitura": {
                        "lab_count": 1
                    },
                    "Ministerio de cultura": {
                        "lab_count": 1
                    },
                    "Prefectura Jundiaí": {
                        "lab_count": 1
                    },
                    "Prefectura Municipal Araras": {
                        "lab_count": 1
                    },
                    "Prefectura Municipal de Curitiba": {
                        "lab_count": 1
                    },
                    "Prefectura de Santos": {
                        "lab_count": 1
                    },
                    "Secretaria Municipal de Cultura y Economía Creativa": {
                        "lab_count": 1
                    },
                    "Secretaria Municipal de Inovação e Tecnologia": {
                        "lab_count": 1
                    }
                }
            }
        }
    }
    };
    
    // --- VENN.JS DATA (Tamaños de las áreas) ---
    // *** AJUSTA ESTOS TAMAÑOS con los conteos reales de tu base de datos ***
    const ecosystemData = [
        {sets: ['Civiles'], size: 108, label: 'Civil Society 62', color: '#1b9e77'},
        {sets: ['Educacionales'], size: 87, label: 'Educational 26', color: '#d95f02'},
        {sets: ['Gubernamentales'], size: 52, label: 'Governmental 9', color: '#7570b3'},
        
        // Intersecciones (debes calcular la suma de labs en cada intersección)
        {sets: ['Civiles', 'Educacionales'], size: 31, label: '31'},
        {sets: ['Civiles', 'Gubernamentales'], size: 13, label: '13'},
        {sets: ['Educacionales', 'Gubernamentales'], size: 28, label: '28'},
        {sets: ['Civiles', 'Educacionales', 'Gubernamentales'], size: 2, label: '2'}
    ];

    // --- CONFIGURACIÓN Y FUNCIONES AUXILIARES ---
    
    // Mapeo de Colores (AJUSTAR: Añade todas tus Afiliaciones aquí)
    const AFFILIATION_COLORS = {
        "Universidad Federal ABC (UFABC)": "#4B54A3", 
        "Asociación civil u ONG": "#F39C12", 
        "Independiente": "#27AE60",
        "None": "#606060", // Color para agrupaciones sin afiliación específica
        "Firjan/SENAI": "#D8234B",
        // ... añade el resto de tus afiliaciones
    };

    function getColorByAffiliation(d) {
        return AFFILIATION_COLORS[d.affiliation] || "#888888"; 
    }
    
    const DOT_RADIUS = 3;
    const SPREAD_FACTOR = 0.8; 

    // Función de Posicionamiento Aleatorio (Geometry)
    function getRandomPositionInCircle(centerX, centerY, radius) {
        const angle = Math.random() * 2 * Math.PI;
        const radius_sq = Math.random() * radius * radius;
        const r_rand = Math.sqrt(radius_sq); 

        return {
            x: centerX + r_rand * Math.cos(angle),
            y: centerY + r_rand * Math.sin(angle)
        };
    }

    // --- 5. FUNCIÓN DE DIBUJO DEL DIAGRAMA DE VENN ---
    function drawVennDiagram(sets) {
        const chart = venn.VennDiagram()
            .width(600)
            .height(400);

        d3.select("#venn-diagram-svg-wrapper")
            .datum(sets)
            .call(chart)
            .select("svg")
            .attr("viewBox", "0 0 600 400"); // Asegura que el SVG sea responsivo

        // Añadir evento de click a las áreas
        d3.selectAll("#venn-diagram-svg-wrapper .venn-area")
            .on("click", function(event, d) {
                // Genera el nombre de la intersección/set para el filtro
                const filter = d.sets.map(s => s.label).join('/');
                applyFilter(filter);
            });
            
        // Etiqueta 'All' para resetear
        d3.select("#venn-diagram-svg-wrapper svg")
            .append("text")
            .attr("x", 50)
            .attr("y", 50)
            .attr("fill", "white")
            .attr("cursor", "pointer")
            .text("Total: 171")
            .on("click", () => applyFilter('all'));
    }

    // --- 6. FUNCIÓN DE DIBUJO DE PUNTOS (DOT PLOT) ---
    function drawDots(dataStructure) {
        const svg = d3.select("#venn-diagram-svg-wrapper svg");
        svg.selectAll(".dot-container").remove(); // Limpiar contenedor de puntos
        
        const dotGroup = svg.append("g").attr("class", "dot-container");
        let allDots = [];

        // Iterar sobre las 7 regiones
        Object.keys(dataStructure).forEach(regionKey => {
            const regionData = dataStructure[regionKey];
            const { cx, cy, r } = regionData.coords; 
            
            // Iterar sobre los grupos de Afilicación
            Object.keys(regionData.affiliation_groups).forEach(affiliationKey => {
                const affiliationGroup = regionData.affiliation_groups[affiliationKey];
                
                // Iterar sobre los Subgrupos de Red
                Object.keys(affiliationGroup.network_subgroups).forEach(networkKey => {
                    const labCount = affiliationGroup.network_subgroups[networkKey].lab_count;

                    for (let i = 0; i < labCount; i++) {
                        const position = getRandomPositionInCircle(cx, cy, r * SPREAD_FACTOR); 
                        
                        allDots.push({
                            x: position.x,
                            y: position.y,
                            region: regionKey,
                            affiliation: affiliationKey,
                            network: networkKey,
                            id: `${regionKey}-${affiliationKey}-${i}` 
                        });
                    }
                });
            });
        });

        // Dibujar los círculos SVG
        dotGroup.selectAll(".lab-dot")
            .data(allDots)
            .enter()
            .append("circle")
            .attr("class", "lab-dot")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 0) // Empezar con radio 0 para animación
            .attr("fill", getColorByAffiliation) 
            .attr("opacity", 0.8)
            .transition()
            .duration(500)
            .attr("r", DOT_RADIUS); // Animación de aparición
            
        console.log(`Total de ${allDots.length} puntos dibujados.`);
    }

    // --- 7. FUNCIÓN DE FILTRADO (INTERACCIÓN) ---
    function applyFilter(filter) {
        // 1. Manejar el resaltado de las áreas del Venn (solo opacidad)
        d3.selectAll("#venn-diagram-svg-wrapper .venn-area")
            .transition()
            .duration(300)
            .attr("fill-opacity", function(d) {
                const areaName = d.sets.map(s => s.label).join('/');
                if (filter === 'all' || areaName === filter) {
                    return 0.6; // Opacidad normal
                }
                return 0.1; // Desvanecer otras áreas
            });

        // 2. Manejar el resaltado de los puntos (dots)
        d3.selectAll(".lab-dot")
            .transition()
            .duration(300)
            .attr("opacity", function(d) {
                // La lógica del filtro debe coincidir con la REGION (la clave del JSON)
                if (filter === 'all' || d.region === filter) {
                    return 0.8;
                }
                return 0.1; 
            });
    }

    // --- EJECUCIÓN INICIAL ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Dibuja el Venn (las áreas)
        drawVennDiagram(ecosystemData); 
        
        // 2. Dibuja los puntos (dots)
        drawDots(LAB_STRUCTURE_DATA);
        
        // 3. Establece el filtro inicial
        applyFilter('all');
    });
    
</script>

</body>
</html>
