<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BR Citizen Labs — Ecosystem</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/venn.js"></script>

<style>

body {
    margin: 0;
    padding: 0;
    font-family: 'Courier New', 'Lucida Console', Monaco, Monospace;
    background-color: #808000;
    color: white;
}

header {
    background-color: #ffffff;
    color: black;
    padding: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border-radius: 15px;
    margin: 20px;
}
/* ... (Estilos de encabezado y navegación omitidos por brevedad) ... */
.header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.header-content h1 {
    margin: 0;
    font-size: 1.8rem;
    text-align: center;
}

header h2 {
    color: #4b54a3;
    text-align: center;
    font-size: 1rem;
    font-weight: 400;
    top-margin: 0;
}

.large-left-btn {
    width: 70px;
    height: 70px;
    background-color: white;
    border: 3px solid black;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background-color 0.2s;
}

.large-left-btn img {
    width: 80%;
    height: 80%;
    object-fit: contain;
}

.large-left-btn:hover {
    transform: scale(1.05);
    background-color: #eee;
}

.button-container {
    display: flex;
    gap: 10px;
}

.round-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid black;
    overflow: hidden;
    background-color: #ffffff;
    transition: transform 0.2s;
}

.round-btn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.round-btn:hover {
    transform: scale(1.1);
}

.page-menu {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 10px 10px;
}

.page-menu a {
    padding: 8px 14px;
    border: 2px solid transparent;
    color: white;
    text-decoration: none;
    font-family: inherit;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: 0.15s;
}

.page-menu a:hover {
    transform: scale(1.05);
}

body[data-page="ecosystem"] .page-menu a[data-page="ecosystem"],
body[data-page="geolocation"] .page-menu a[data-page="geolocation"],
body[data-page="analysis"] .page-menu a[data-page="analysis"] {
    border-color: white;
}

#main-content {
    margin: 0 20px 30px 20px;
    border-radius: 15px;
    padding: 20px;
    background: rgba(0,0,0,0.12);
}

/* ESTILOS CSS PARA LA VISUALIZACIÓN */
#venn-diagram-svg-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    /* Establece un tamaño base para la visualización */
    max-width: 600px; 
    margin-left: auto;
    margin-right: auto;
}

.venn-area {
    fill-opacity: 0.6;
    stroke: #fff;
    stroke-width: 2px;
    transition: fill-opacity 0.2s;
    cursor: pointer; /* Indica que es clickeable */
}

/* Estilos de las etiquetas de conjunto (los nombres Civiles, Educacionales, etc) */
.venn-area-label text {
    fill: white;
    font-size: 14px;
    font-weight: bold;
}

.lab-dot {
    stroke: none;
    transition: opacity 0.3s;
    cursor: pointer;
}

/* Tooltip simple para D3 */
.venn-tooltip {
    line-height: 1.2;
    font-family: Arial, sans-serif;
    font-size: 13px;
    z-index: 1000;
}

@media(min-width: 768px) {
    .header-content { flex-direction: row; justify-content: space-between; align-items: center; }
    .header-content h1 { font-size: 2rem; }
    .page-menu { justify-content: center; margin-left: 20px; }
}
</style>
</head>
<body class="ecosystem" data-page="ecosystem">

<header>
    <div class="header-content">
        <a href="https://drive.google.com/file/d/1XaMD08p6vzy4FUFhi-qIKKLY2gouoTua/view?usp=sharing" target="_blank" class="large-left-btn">
             <img src="https://via.placeholder.com/70x70.png?text=DOC" alt="Home Link Icon">
        </a>

        <h1>Brazilian Citizen Labs</h1>

        <div class="button-container">
            <a href="https://br.linkedin.com/in/valentina-melgar-bermúdez-a9b3712b8" target="_blank" class="round-btn">
                 <img src="https://via.placeholder.com/40x40.png?text=L" alt="LinkedIn">
            </a>
            <a href="https://tinahmb.substack.com/" target="_blank" class="round-btn">
                 <img src="https://via.placeholder.com/40x40.png?text=S" alt="Substack">
            </a>
        </div>
    </div>

    <h2>by Valentina Melgar Bermúdez</h2>
</header>

<nav class="page-menu" aria-label="Site pages">
    <a href="index.html" data-page="geolocation">Geolocation</a>
    <a href="ecosystem.html" data-page="ecosystem">Ecosystem</a>
    <a href="analysis.html" data-page="analysis">Analysis</a>
</nav>

<div id="main-content">
    <h3>Diagrama del Ecosistema de Laboratorios (171 Labs)</h3>
    <p>Haz clic en las áreas del diagrama para filtrar por región.</p>
    
    <div id="venn-diagram-svg-wrapper"></div>
</div>

<script>
    
    // --- 1. DATOS DEL USUARIO (JSON) ---
    const LAB_STRUCTURE_DATA = {
        "Civiles": {
            "coords": { "cx": 180, "cy": 180, "r": 120, "name": "Solo Civiles" },
            "affiliation_groups": {
                "Firjan/SENAI": { "total_labs": 11, "network_subgroups": { "Federação das Indústrias do Estado do Rio de Janeiro (Firjan)/(Servicio Nacional de Aprendizaje Industrial) SENAI": { "lab_count": 9 }, "Federação das Indústrias do Estado do Rio de Janeiro (Firjan)/Servicio Nacional de Aprendizaje Industrial (SENAI)": { "lab_count": 2 } } },
                "Grupo Tiradentes": { "total_labs": 1, "network_subgroups": { "Tiradentes Innovation Center": { "lab_count": 1 } } },
                "Movimento +Social Good": { "total_labs": 1, "network_subgroups": { "Fundação das Nações Unidas": { "lab_count": 1 } } },
                "None": { "total_labs": 45, "network_subgroups": { "Agencia Kerno": { "lab_count": 1 }, "Caravana Digital SIP": { "lab_count": 1 }, "Fora do Eixo": { "lab_count": 1 }, "Grupo de Assessoria de Mobilização de Talentos (GAMT)": { "lab_count": 1 }, "Lab Maker Living Lab": { "lab_count": 1 }, "Machado Meyer Advogados": { "lab_count": 1 }, "Makers Manaus": { "lab_count": 1 }, "Midia Ninja": { "lab_count": 1 }, "None": { "lab_count": 32 }, "O nosso papel ONG": { "lab_count": 1 }, "Parque Tecnológico de Sorocaba": { "lab_count": 1 }, "Parque de Desarrollo Tecnológico (PADETEC)": { "lab_count": 1 }, "SHC - Santos Hacker Clube": { "lab_count": 1 }, "Serviço Brasileiro de Apoio às Micro e Pequenas Empresas de Mato Grosso do Sul (SEBRAE MS)": { "lab_count": 1 } } },
                "SENAI": { "total_labs": 2, "network_subgroups": { "Federação das Indústrias do Estado de Minas Gerais (FIEMG)": { "lab_count": 1 }, "Servicio Nacional de Aprendizaje Industrial (SENAI)": { "lab_count": 1 } } },
                "Sistema Federación de las industrias del Estado de Paraná (FIEP)": { "total_labs": 2, "network_subgroups": { "SESI/SENAI/Instituto Euvaldo Lodi (IEL)": { "lab_count": 2 } } }
            }
        },
        "Civiles/Educacionales": {
            "coords": { "cx": 320, "cy": 120, "r": 60, "name": "C ∩ E" },
            "affiliation_groups": {
                "Escola SESI": { "total_labs": 30, "network_subgroups": { "Servicio Social de la Industria (SESI)": { "lab_count": 30 } } },
                "None": { "total_labs": 1, "network_subgroups": { "Fundação Helena Antipoff": { "lab_count": 1 } } }
            }
        },
        "Civiles/Educacionales/Gubernamentales": {
            "coords": { "cx": 300, "cy": 220, "r": 30 },
            "affiliation_groups": {
                "None": { "total_labs": 2, "network_subgroups": { "SENAI/Universidad Federal de Goiás": { "lab_count": 1 }, "Universidad Estatal de Mato Grosso do Sul (UEMS)/SENAI": { "lab_count": 1 } } }
            }
        },
        "Civiles/Gubernamentales": {
            "coords": { "cx": 250, "cy": 280, "r": 60, "name": "C ∩ G" },
            "affiliation_groups": {
                "FAB LAB LIVRE SP": { "total_labs": 13, "network_subgroups": { "Pefectura Municipal SP/Instituto de Tecnologia Social (ITS) BRASIL": { "lab_count": 13 } } }
            }
        },
        "Educacionales": {
            "coords": { "cx": 420, "cy": 180, "r": 120, "name": "Solo Educacionales" },
            "affiliation_groups": {
                "Amadomaker": { "total_labs": 1, "network_subgroups": { "Universidad de Passo Fundo (UPF)": { "lab_count": 1 } } },
                "American Spaces": { "total_labs": 2, "network_subgroups": { "ABA": { "lab_count": 1 }, "Casa Thomas Jefferson/Departamento de Estado de EUA": { "lab_count": 1 } } },
                "Escola Concept": { "total_labs": 3, "network_subgroups": { "Escola Concept": { "lab_count": 3 } } },
                "Fablab Mauá": { "total_labs": 2, "network_subgroups": { "Instituto Mauá de Tecnologia": { "lab_count": 2 } } },
                "Facens": { "total_labs": 2, "network_subgroups": { "Faculdade de Engenharia de Sorocaba (Facens)": { "lab_count": 2 } } },
                "None": { "total_labs": 13, "network_subgroups": { "Centro Universitario Paraíso (UniFAP)": { "lab_count": 1 }, "Centro Universitario de Excelencia en Guarulhos (ENIAC)": { "lab_count": 1 }, "Centro universitario de Patos de Minas (Unipam)": { "lab_count": 1 }, "Escola Castanheiras": { "lab_count": 1 }, "Fundação Torino": { "lab_count": 1 }, "Newton": { "lab_count": 1 }, "Pontificia Universidad Católica de Río Grande del Sur (PUCRS)": { "lab_count": 1 }, "Sinergia": { "lab_count": 1 }, "Universidad de Araraquara (Uniara)": { "lab_count": 1 }, "Universidad de Vale do Rio dos Sinos (Unisinos)": { "lab_count": 1 }, "Universidad de la Salle (Unilasalle)": { "lab_count": 1 }, "Universidade Paulista (UNIP)": { "lab_count": 1 }, "Universidade Presbiteriana Mackenzie": { "lab_count": 1 } } },
                "Pronto3D": { "total_labs": 1, "network_subgroups": { "Universidad Comunitaria de la región de Chapecó (Unochapecó)": { "lab_count": 1 } } },
                "Ânima Lab": { "total_labs": 2, "network_subgroups": { "Centro Universitario de Belo Horizonte (UniBH)": { "lab_count": 1 }, "São Judas Unimonte": { "lab_count": 1 } } }
            }
        },
        "Educacionales/Gubernamentales": {
            "coords": { "cx": 380, "cy": 280, "r": 60, "name": "E ∩ G" },
            "affiliation_groups": {
                "Amadomaker": { "total_labs": 1, "network_subgroups": { "Prefectura Municipal de Passo Fundo/Escuela de las profesiones": { "lab_count": 1 } } },
                "Enactus": { "total_labs": 1, "network_subgroups": { "Universidade Federal do Rio de Janeiro (UFRJ)": { "lab_count": 1 } } },
                "IFMaker": { "total_labs": 1, "network_subgroups": { "Instituto Federal de Tocantins (IFTO)": { "lab_count": 1 } } },
                "Lablivre/Wikilab": { "total_labs": 1, "network_subgroups": { "Universidad Federal ABC (UFABC)": { "lab_count": 1 } } },
                "None": { "total_labs": 23, "network_subgroups": { "\"Instituto Estadual de Educação": { "lab_count": 1 }, "\"Instituto Federal de Educación": { "lab_count": 3 }, "\"Instituto Federal de Educação": { "lab_count": 1 }, "Centro de Tecnologia Acadêmica do Instituto de Física (CTA IF)/Universidad Federal de Río Grande del Sur": { "lab_count": 1 }, "Escola Municipal de Ensino Fundamental Doutor Paulo da Silva Couto": { "lab_count": 1 }, "Faculdade de Tecnologia de Araraquara (Fatec Arq)-Centro Paula Souza": { "lab_count": 1 }, "Instituto Anísio Teixeira": { "lab_count": 1 }, "Instituto de Física de la Universidad de SP (IFUSP)": { "lab_count": 1 }, "Universidad Estatal de Campinas (UNICAMP)": { "lab_count": 1 }, "Universidad Federal de Mato Grosso (UFMG)": { "lab_count": 1 }, "Universidad Federal de Mato Grosso (UFMT)": { "lab_count": 1 }, "Universidad Federal de Paraíba (UFPB)": { "lab_count": 1 }, "Universidad Federal de Rio Grande do Sur (UFRGS)": { "lab_count": 1 }, "Universidad Federal de Río Grande del Sur": { "lab_count": 1 }, "Universidad Federal de Santa Catarina (UFSC)": { "lab_count": 1 }, "Universidad Federal de São Carlos (UFSCar)": { "lab_count": 1 }, "Universidad Federal del Oeste de Bahia (UFOB)": { "lab_count": 1 }, "Universidad de Blumenau (FURB)": { "lab_count": 1 }, "Universidade Estadual Paulista (UNESP)/Sagui lab": { "lab_count": 1 }, "Universidade Federal do Piauí (UFPI)": { "lab_count": 1 }, "Universidade Federal do Rio de Janeiro (UFRJ)": { "lab_count": 1 } } },
                "Pronto3D": { "total_labs": 1, "network_subgroups": { "Universidad Federal de Santa Catarina (UFSC)": { "lab_count": 1 } } }
            }
        },
        "Gubernamentales": {
            "coords": { "cx": 300, "cy": 350, "r": 120, "name": "Solo Gubernamentales" },
            "affiliation_groups": {
                "None": { "total_labs": 9, "network_subgroups": { "Cámara de Diputados Federal": { "lab_count": 1 }, "Ministerio de cuitura": { "lab_count": 1 }, "Ministerio de cultura": { "lab_count": 1 }, "Prefectura Jundiaí": { "lab_count": 1 }, "Prefectura Municipal Araras": { "lab_count": 1 }, "Prefectura Municipal de Curitiba": { "lab_count": 1 }, "Prefectura de Santos": { "lab_count": 1 }, "Secretaria Municipal de Cultura y Economía Creativa": { "lab_count": 1 }, "Secretaria Municipal de Inovação e Tecnologia": { "lab_count": 1 } } }
            }
        }
    };
    
    // --- 2. DATOS CALCULADOS PARA VENN.JS ---
    const ecosystemData = [
        // Sets puros (Total de labs que caen SÓLO en esa región)
        {sets: ['Civiles'], size: 62, label: 'Civiles', color: '#1b9e77'},
        {sets: ['Educacionales'], size: 26, label: 'Educacionales', color: '#d95f02'},
        {sets: ['Gubernamentales'], size: 9, label: 'Gubernamentales', color: '#7570b3'},
        
        // Intersecciones (Total de labs que caen SÓLO en esa intersección)
        {sets: ['Civiles', 'Educacionales'], size: 31},
        {sets: ['Civiles', 'Gubernamentales'], size: 13},
        {sets: ['Educacionales', 'Gubernamentales'], size: 28},
        
        // Intersección triple
        {sets: ['Civiles', 'Educacionales', 'Gubernamentales'], size: 2}
    ];

    // --- 3. CONFIGURACIÓN DE COLORES ---
    const AFFILIATION_COLORS = {
        "Firjan/SENAI": "#D8234B", 
        "None": "#606060",
        "Escola SESI": "#4B54A3",
        "FAB LAB LIVRE SP": "#1ABC9C",
        "SENAI": "#F39C12",
        "Grupo Tiradentes": "#5D6D7E",
        "Movimento +Social Good": "#A569BD",
        "Sistema Federación de las industrias del Estado de Paraná (FIEP)": "#45B39D",
        "Amadomaker": "#F08080",
        "American Spaces": "#A9CCE3",
        "Escola Concept": "#FAD7A0",
        "Fablab Mauá": "#7DCEA0",
        "Facens": "#5499C7",
        "Pronto3D": "#CD6155",
        "Ânima Lab": "#F4D03F",
        "Enactus": "#85C1E9",
        "IFMaker": "#D2B4DE",
        "Lablivre/Wikilab": "#76D7C4"
        // Asegúrate de añadir cualquier otra afiliación clave
    };

    function getColorByAffiliation(d) {
        return AFFILIATION_COLORS[d.affiliation] || "#888888"; 
    }
    
    const DOT_RADIUS = 3;
    const SPREAD_FACTOR = 0.8; 

    // Función de Posicionamiento Aleatorio (Geometry) - *** COMPLETADA ***
    function getRandomPositionInCircle(centerX, centerY, radius) {
        const angle = Math.random() * 2 * Math.PI;
        // Reduce el radio aleatorio para forzar los puntos hacia el centro (menos ruido en bordes)
        const r = Math.sqrt(Math.random()) * radius * SPREAD_FACTOR;
        return {
            x: centerX + r * Math.cos(angle),
            y: centerY + r * Math.sin(angle)
        };
    }

    // --- 4. Preparación de los datos planos (Flat Data) para los puntos ---
    let LAB_DOT_DATA = [];
    let labIdCounter = 1;

    // Mapeo de la lógica de intersección a las etiquetas de los sets
    const TYPE_TO_SETS = {
        "Civiles": ['Civiles'],
        "Educacionales": ['Educacionales'],
        "Gubernamentales": ['Gubernamentales'],
        "Civiles/Educacionales": ['Civiles', 'Educacionales'],
        "Civiles/Gubernamentales": ['Civiles', 'Gubernamentales'],
        "Educacionales/Gubernamentales": ['Educacionales', 'Gubernamentales'],
        "Civiles/Educacionales/Gubernamentales": ['Civiles', 'Educacionales', 'Gubernamentales']
    };

    for (const type in LAB_STRUCTURE_DATA) {
        const structure = LAB_STRUCTURE_DATA[type];
        for (const affiliation in structure.affiliation_groups) {
            const group = structure.affiliation_groups[affiliation];
            // Generar un punto por cada lab en el grupo de afiliación.
            for (let i = 0; i < group.total_labs; i++) {
                // Generar un nombre de subgrupo para el tooltip, alternando entre los disponibles.
                const subgroups = Object.keys(group.network_subgroups);
                const subgroupName = subgroups[i % subgroups.length];
                
                LAB_DOT_DATA.push({
                    id: labIdCounter++,
                    type: type, // e.g., 'Civiles' or 'Civiles/Educacionales'
                    sets: TYPE_TO_SETS[type], // Array de sets para mapeo de coordenadas
                    affiliation: affiliation,
                    subgroup: subgroupName,
                    total_in_region: structure.total_labs,
                });
            }
        }
    }

    // --- 5. Función de Dibujo Principal ---
    function drawVennDiagram(data, dotData) {
        const svgWrapper = d3.select("#venn-diagram-svg-wrapper");
        svgWrapper.selectAll("*").remove(); // Limpiar el SVG anterior

        const width = 600;
        const height = 450;

        const chart = venn.VennDiagram()
            .width(width)
            .height(height)
            .styled(false); // Usar los estilos CSS

        const svg = svgWrapper.append("svg")
            .attr("width", width)
            .attr("height", height)
            .datum(data)
            .call(chart);
            
        // Obtener las coordenadas calculadas por venn.js
        const layout = svg.datum();
        let areaToCoords = {};

        // Mapear la clave de la intersección (e.g. 'Civiles/Educacionales') a sus coordenadas de centroide
        layout.forEach(d => {
            const setsKey = d.sets.sort().join("/");
            areaToCoords[setsKey] = d.center;
            // También guardamos el radio para dispersión
            areaToCoords[setsKey].radius = d.radius || 100;
        });

        // --- 5.1. Dibujar los Puntos de Laboratorios (Dots) ---
        const allGroups = svg.append("g").attr("class", "lab-dots-group");

        // Asignar coordenadas a cada punto antes de dibujar
        dotData.forEach(d => {
            const setsKey = d.sets.sort().join("/");
            const center = areaToCoords[setsKey] || {x: width / 2, y: height / 2, radius: 100};
            
            // Usar la mitad del radio para dispersar los puntos
            const radiusForSpread = center.radius;
            
            const pos = getRandomPositionInCircle(center.x, center.y, radiusForSpread / 2);
            d.x = pos.x;
            d.y = pos.y;
        });

        // Dibujar los puntos
        const dots = allGroups.selectAll(".lab-dot")
            .data(dotData)
            .enter()
            .append("circle")
            .attr("class", d => `lab-dot ${d.type.split('/').map(t => t.trim().toLowerCase()).join('-')}`)
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", DOT_RADIUS)
            .style("fill", d => getColorByAffiliation(d))
            .attr("data-type", d => d.type)
            .attr("opacity", 1);


        // --- 5.2. Tooltip (Contenedor) ---
        const tooltip = d3.select("body").append("div")
            .attr("class", "venn-tooltip")
            .style("position", "absolute")
            .style("visibility", "hidden")
            .style("background-color", "rgba(0,0,0,0.8)")
            .style("color", "white")
            .style("padding", "5px 8px")
            .style("border-radius", "5px")
            .style("pointer-events", "none");

        // --- 5.3. Interacciones (Áreas) ---
        svg.selectAll(".venn-area")
            .on("mouseover", function(event, d) {
                // Mover el área a la parte superior para que el texto sea visible
                venn.sortAreas(svg, d); 

                d3.select(this).select("path").style("fill-opacity", 0.8);

                const regionName = d.sets.join(" y ");
                const labCount = d.size;
                const setType = d.sets.sort().join('/');
                const regionData = LAB_STRUCTURE_DATA[setType];
                
                let tooltipContent = `<b>Región:</b> ${regionName}<br><b>Laboratorios:</b> ${labCount}`;

                if (regionData) {
                    const groups = Object.entries(regionData.affiliation_groups)
                        .sort(([, a], [, b]) => b.total_labs - a.total_labs)
                        .slice(0, 3);

                    if (groups.length > 0) {
                        tooltipContent += "<br><br><b>Top Afiliaciones:</b>";
                        groups.forEach(([name, data]) => {
                            tooltipContent += `<br>- ${name} (${data.total_labs})`;
                        });
                    }
                }
                
                tooltip.html(tooltipContent)
                    .style("top", (event.pageY - 10) + "px")
                    .style("left", (event.pageX + 10) + "px")
                    .style("visibility", "visible");
            })

            .on("mousemove", function(event) {
                tooltip.style("top", (event.pageY - 10) + "px")
                       .style("left", (event.pageX + 10) + "px");
            })

            .on("mouseout", function(event, d) {
                d3.select(this).select("path").style("fill-opacity", 0.6);
                tooltip.style("visibility", "hidden");
            })
            
            // --- 5.4. Lógica de Filtrado (Click) ---
            .on("click", function(event, d) {
                const clickedSets = d.sets.sort().join("/");
                
                const currentFilter = svgWrapper.attr("data-filter");
                const newFilter = currentFilter === clickedSets ? "" : clickedSets; // Alternar filtro

                svgWrapper.attr("data-filter", newFilter);

                // Filtrar y animar los puntos
                dots.transition().duration(300)
                    .attr("opacity", dotD => {
                        const dotSets = dotD.sets.sort().join("/");
                        if (newFilter === "") return 1; 
                        return dotSets === newFilter ? 1 : 0.1; 
                    })
                    .attr("r", dotD => {
                        const dotSets = dotD.sets.sort().join("/");
                        // Hacer los puntos filtrados un poco más grandes para resaltarlos
                        if (newFilter !== "" && dotSets === newFilter) return DOT_RADIUS * 1.5;
                        return DOT_RADIUS;
                    });
            });

        // --- 5.5. Interacciones (Puntos) ---
        dots.on("mouseover", function(event, d) {
            d3.select(this).attr("r", DOT_RADIUS * 2.5).style("stroke", "white").style("stroke-width", "1px"); // Agrandar y destacar

            const labDetails = `
                <b>Tipo:</b> ${d.type.replace(/\//g, ' / ')}<br>
                <b>Afiliación:</b> ${d.affiliation}<br>
                <b>Red/Entidad:</b> ${d.subgroup}
            `;

            tooltip.html(labDetails)
                .style("top", (event.pageY - 10) + "px")
                .style("left", (event.pageX + 10) + "px")
                .style("visibility", "visible");
        })
        .on("mousemove", function(event) {
            tooltip.style("top", (event.pageY - 10) + "px")
                   .style("left", (event.pageX + 10) + "px");
        })
        .on("mouseout", function(event, d) {
            d3.select(this).attr("r", DOT_RADIUS).style("stroke", "none"); // Restaurar tamaño

            // Ocultar tooltip solo si no estamos sobre un área de Venn
            if (d3.select(".venn-area:hover").empty()) {
                tooltip.style("visibility", "hidden");
            }
        });

        // --- 5.6. Estilos adicionales para las etiquetas ---
        // Agregar el conteo de labs al texto de la etiqueta del set
        svg.selectAll(".venn-label")
            .each(function(d) {
                d3.select(this).append("text")
                    .attr("x", d.textCenter.x)
                    .attr("y", d.textCenter.y + 15) // Mover un poco hacia abajo
                    .text(`(${d.size})`)
                    .attr("text-anchor", "middle")
                    .style("fill", "white")
                    .style("font-size", "14px");
            });
        
        // Estilo para las etiquetas de intersección (e.g. la '2' del centro)
        svg.selectAll(".venn-intersection-label text")
            .style("fill", "white")
            .style("font-weight", "bold")
            .style("text-shadow", "1px 1px 2px #000"); // Sombra para legibilidad
    }

    // 6. Iniciar el Dibujo
    drawVennDiagram(ecosystemData, LAB_DOT_DATA);

</script>
</body>
</html>
