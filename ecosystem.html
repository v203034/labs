<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BR Citizen Labs — Ecosystem</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/venn.js"></script>

<style>

body {
    margin: 0;
    padding: 0;
    font-family: 'Courier New', 'Lucida Console', Monaco, Monospace;
    background-color: #808000;
    color: white;
}

header {
    background-color: #ffffff;
    color: black;
    padding: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border-radius: 15px;
    margin: 20px;
}
/* ... (Estilos de encabezado y navegación omitidos por brevedad) ... */
.header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.header-content h1 {
    margin: 0;
    font-size: 1.8rem;
    text-align: center;
}

header h2 {
    color: #4b54a3;
    text-align: center;
    font-size: 1rem;
    font-weight: 400;
    top-margin: 0;
}

.large-left-btn {
    width: 70px;
    height: 70px;
    background-color: white;
    border: 3px solid black;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background-color 0.2s;
}

.large-left-btn img {
    width: 80%;
    height: 80%;
    object-fit: contain;
}

.large-left-btn:hover {
    transform: scale(1.05);
    background-color: #eee;
}

.button-container {
    display: flex;
    gap: 10px;
}

.round-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid black;
    overflow: hidden;
    background-color: #ffffff;
    transition: transform 0.2s;
}

.round-btn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.round-btn:hover {
    transform: scale(1.1);
}

.page-menu {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 10px 10px;
}

.page-menu a {
    padding: 8px 14px;
    border: 2px solid transparent;
    color: white;
    text-decoration: none;
    font-family: inherit;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: 0.15s;
}

.page-menu a:hover {
    transform: scale(1.05);
}

body[data-page="ecosystem"] .page-menu a[data-page="ecosystem"],
body[data-page="geolocation"] .page-menu a[data-page="geolocation"],
body[data-page="analysis"] .page-menu a[data-page="analysis"] {
    border-color: white;
}

#main-content {
    margin: 0 20px 30px 20px;
    border-radius: 15px;
    padding: 20px;
    background: rgba(0,0,0,0.12);
}

/* ESTILOS CSS PARA LA VISUALIZACIÓN */
#venn-diagram-svg-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    /* Establece un tamaño base para la visualización */
    max-width: 600px; 
    margin-left: auto;
    margin-right: auto;
}

.venn-area {
    fill-opacity: 0.6;
    stroke: #fff;
    stroke-width: 2px;
    transition: fill-opacity 0.2s;
}

.venn-area-label text {
    fill: white;
    font-size: 14px;
    font-weight: bold;
}

.lab-dot {
    stroke: none;
    transition: opacity 0.3s;
    cursor: pointer;
}

@media(min-width: 768px) {
    .header-content { flex-direction: row; justify-content: space-between; align-items: center; }
    .header-content h1 { font-size: 2rem; }
    .page-menu { justify-content: flex-start; margin-left: 20px; }
}
</style>
</head>
<body class="ecosystem" data-page="ecosystem">

<header>
    <div class="header-content">
        <a href="https://drive.google.com/file/d/1XaMD08p6vzy4FUFhi-qIKKLY2gouoTua/view?usp=sharing" target="_blank" class="large-left-btn">
            <img src="Documentlogo.png" alt="Home Link Icon">
        </a>

        <h1>Brazilian Citizen Labs</h1>

        <div class="button-container">
            <a href="https://br.linkedin.com/in/valentina-melgar-bermúdez-a9b3712b8" target="_blank" class="round-btn">
                <img src="LinkedInlogo.png" alt="LinkedIn">
            </a>
            <a href="https://tinahmb.substack.com/" target="_blank" class="round-btn">
                <img src="Substacklogo.png" alt="Substack">
            </a>
        </div>
    </div>

    <h2>by Valentina Melgar Bermúdez</h2>
</header>

<nav class="page-menu" aria-label="Site pages">
    <a href="index.html" data-page="geolocation">Geolocation</a>
    <a href="ecosystem.html" data-page="ecosystem">Ecosystem</a>
    <a href="analysis.html" data-page="analysis">Analysis</a>
</nav>

<div id="main-content">
    <h3>Diagrama del Ecosistema de Laboratorios (171 Labs)</h3>
    <p>Haz clic en las áreas del diagrama para filtrar por región.</p>
    
    <div id="venn-diagram-svg-wrapper"></div>
</div>

<script>
    
    // --- 1. DATOS DEL USUARIO (JSON) ---
    // ESTOS SON LOS DATOS REALES QUE GENERASTE, CON LOS PLACEHOLDERS DE COORDENADAS.
    const LAB_STRUCTURE_DATA = {
        "Civiles": {
            "coords": {
                // *** AJUSTAR MANUALMENTE DESPUÉS DEL PASO 4 ***
                "cx": 180, "cy": 180, "r": 120, "name": "Solo Civiles" 
            },
            "affiliation_groups": {
                "Firjan/SENAI": {
                    "total_labs": 11,
                    "network_subgroups": {
                        "Federa\u00e7\u00e3o das Ind\u00fastrias do Estado do Rio de Janeiro (Firjan)/(Servicio Nacional de Aprendizaje Industrial) SENAI": {
                            "lab_count": 9
                        },
                        "Federa\u00e7\u00e3o das Ind\u00fastrias do Estado do Rio de Janeiro (Firjan)/Servicio Nacional de Aprendizaje Industrial (SENAI)": {
                            "lab_count": 2
                        }
                    }
                },
                "Grupo Tiradentes": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Tiradentes Innovation Center": {
                            "lab_count": 1
                        }
                    }
                },
                "Movimento +Social Good": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Funda\u00e7\u00e3o das Na\u00e7\u00f5es Unidas": {
                            "lab_count": 1
                        }
                    }
                },
                "None": {
                    "total_labs": 45,
                    "network_subgroups": {
                        "Agencia Kerno": {
                            "lab_count": 1
                        },
                        "Caravana Digital SIP": {
                            "lab_count": 1
                        },
                        "Fora do Eixo": {
                            "lab_count": 1
                        },
                        "Grupo de Assessoria de Mobiliza\u00e7\u00e3o de Talentos (GAMT)": {
                            "lab_count": 1
                        },
                        "Lab Maker Living Lab": {
                            "lab_count": 1
                        },
                        "Machado Meyer Advogados": {
                            "lab_count": 1
                        },
                        "Makers Manaus": {
                            "lab_count": 1
                        },
                        "Midia Ninja": {
                            "lab_count": 1
                        },
                        "None": {
                            "lab_count": 32
                        },
                        "O nosso papel ONG": {
                            "lab_count": 1
                        },
                        "Parque Tecnol\u00f3gico de Sorocaba": {
                            "lab_count": 1
                        },
                        "Parque de Desarrollo Tecnol\u00f3gico (PADETEC)": {
                            "lab_count": 1
                        },
                        "SHC - Santos Hacker Clube": {
                            "lab_count": 1
                        },
                        "Servi\u00e7o Brasileiro de Apoio \u00e0s Micro e Pequenas Empresas de Mato Grosso do Sul (SEBRAE MS)": {
                            "lab_count": 1
                        }
                    }
                },
                "SENAI": {
                    "total_labs": 2,
                    "network_subgroups": {
                        "Federa\u00e7\u00e3o das Ind\u00fastrias do Estado de Minas Gerais (FIEMG)": {
                            "lab_count": 1
                        },
                        "Servicio Nacional de Aprendizaje Industrial (SENAI)": {
                            "lab_count": 1
                        }
                    }
                },
                "Sistema Federaci\u00f3n de las industrias del Estado de Paran\u00e1 (FIEP)": {
                    "total_labs": 2,
                    "network_subgroups": {
                        "SESI/SENAI/Instituto Euvaldo Lodi (IEL)": {
                            "lab_count": 2
                        }
                    }
                }
            }
        },
        "Civiles/Educacionales": {
            "coords": {
                // *** AJUSTAR MANUALMENTE DESPUÉS DEL PASO 4 ***
                "cx": 320, "cy": 120, "r": 60, "name": "C \u2229 E"
            },
            "affiliation_groups": {
                "Escola SESI": {
                    "total_labs": 30,
                    "network_subgroups": {
                        "Servicio Social de la Industria (SESI)": {
                            "lab_count": 30
                        }
                    }
                },
                "None": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Funda\u00e7\u00e3o Helena Antipoff": {
                            "lab_count": 1
                        }
                    }
                }
            }
        },
        "Civiles/Educacionales/Gubernamentales": {
            "coords": {
                // *** AJUSTAR MANUALMENTE DESPUÉS DEL PASO 4 ***
                "cx": 300, "cy": 220, "r": 30
            },
            "affiliation_groups": {
                "None": {
                    "total_labs": 2,
                    "network_subgroups": {
                        "SENAI/Universidad Federal de Goi\u00e1s": {
                            "lab_count": 1
                        },
                        "Universidad Estatal de Mato Grosso do Sul (UEMS)/SENAI": {
                            "lab_count": 1
                        }
                    }
                }
            }
        },
        "Civiles/Gubernamentales": {
            "coords": {
                // *** AJUSTAR MANUALMENTE DESPUÉS DEL PASO 4 ***
                "cx": 250, "cy": 280, "r": 60, "name": "C \u2229 G"
            },
            "affiliation_groups": {
                "FAB LAB LIVRE SP": {
                    "total_labs": 13,
                    "network_subgroups": {
                        "Pefectura Municipal SP/Instituto de Tecnologia Social (ITS) BRASIL": {
                            "lab_count": 13
                        }
                    }
                }
            }
        },
        "Educacionales": {
            "coords": {
                // *** AJUSTAR MANUALMENTE DESPUÉS DEL PASO 4 ***
                "cx": 420, "cy": 180, "r": 120, "name": "Solo Educacionales"
            },
            "affiliation_groups": {
                "Amadomaker": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Universidad de Passo Fundo (UPF)": {
                            "lab_count": 1
                        }
                    }
                },
                "American Spaces": {
                    "total_labs": 2,
                    "network_subgroups": {
                        "ABA": {
                            "lab_count": 1
                        },
                        "Casa Thomas Jefferson/Departamento de Estado de EUA": {
                            "lab_count": 1
                        }
                    }
                },
                "Escola Concept": {
                    "total_labs": 3,
                    "network_subgroups": {
                        "Escola Concept": {
                            "lab_count": 3
                        }
                    }
                },
                "Fablab Mau\u00e1": {
                    "total_labs": 2,
                    "network_subgroups": {
                        "Instituto Mau\u00e1 de Tecnologia": {
                            "lab_count": 2
                        }
                    }
                },
                "Facens": {
                    "total_labs": 2,
                    "network_subgroups": {
                        "Faculdade de Engenharia de Sorocaba (Facens)": {
                            "lab_count": 2
                        }
                    }
                },
                "None": {
                    "total_labs": 13,
                    "network_subgroups": {
                        "Centro Universitario Para\u00edso (UniFAP)": {
                            "lab_count": 1
                        },
                        "Centro Universitario de Excelencia en Guarulhos (ENIAC)": {
                            "lab_count": 1
                        },
                        "Centro universitario de Patos de Minas (Unipam)": {
                            "lab_count": 1
                        },
                        "Escola Castanheiras": {
                            "lab_count": 1
                        },
                        "Funda\u00e7\u00e3o Torino": {
                            "lab_count": 1
                        },
                        "Newton": {
                            "lab_count": 1
                        },
                        "Pontificia Universidad Cat\u00f3lica de R\u00edo Grande del Sur (PUCRS)": {
                            "lab_count": 1
                        },
                        "Sinergia": {
                            "lab_count": 1
                        },
                        "Universidad de Araraquara (Uniara)": {
                            "lab_count": 1
                        },
                        "Universidad de Vale do Rio dos Sinos (Unisinos)": {
                            "lab_count": 1
                        },
                        "Universidad de la Salle (Unilasalle)": {
                            "lab_count": 1
                        },
                        "Universidade Paulista (UNIP)": {
                            "lab_count": 1
                        },
                        "Universidade Presbiteriana Mackenzie": {
                            "lab_count": 1
                        }
                    }
                },
                "Pronto3D": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Universidad Comunitaria de la regi\u00f3n de Chapec\u00f3 (Unochapec\u00f3)": {
                            "lab_count": 1
                        }
                    }
                },
                "\u00c2nima Lab": {
                    "total_labs": 2,
                    "network_subgroups": {
                        "Centro Universitario de Belo Horizonte (UniBH)": {
                            "lab_count": 1
                        },
                        "S\u00e3o Judas Unimonte": {
                            "lab_count": 1
                        }
                    }
                }
            }
        },
        "Educacionales/Gubernamentales": {
            "coords": {
                // *** AJUSTAR MANUALMENTE DESPUÉS DEL PASO 4 ***
                "cx": 380, "cy": 280, "r": 60, "name": "E \u2229 G"
            },
            "affiliation_groups": {
                "Amadomaker": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Prefectura Municipal de Passo Fundo/Escuela de las profesiones": {
                            "lab_count": 1
                        }
                    }
                },
                "Enactus": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Universidade Federal do Rio de Janeiro (UFRJ)": {
                            "lab_count": 1
                        }
                    }
                },
                "IFMaker": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Instituto Federal de Tocantins (IFTO)": {
                            "lab_count": 1
                        }
                    }
                },
                "Lablivre/Wikilab": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Universidad Federal ABC (UFABC)": {
                            "lab_count": 1
                        }
                    }
                },
                "None": {
                    "total_labs": 23,
                    "network_subgroups": {
                        "\"Instituto Estadual de Educa\u00e7\u00e3o": {
                            "lab_count": 1
                        },
                        "\"Instituto Federal de Educaci\u00f3n": {
                            "lab_count": 3
                        },
                        "\"Instituto Federal de Educa\u00e7\u00e3o": {
                            "lab_count": 1
                        },
                        "Centro de Tecnologia Acad\u00eamica do Instituto de F\u00edsica (CTA IF)/Universidad Federal de R\u00edo Grande del Sur": {
                            "lab_count": 1
                        },
                        "Escola Municipal de Ensino Fundamental Doutor Paulo da Silva Couto": {
                            "lab_count": 1
                        },
                        "Faculdade de Tecnologia de Araraquara (Fatec Arq)-Centro Paula Souza": {
                            "lab_count": 1
                        },
                        "Instituto An\u00edsio Teixeira": {
                            "lab_count": 1
                        },
                        "Instituto de F\u00edsica de la Universidad de SP (IFUSP)": {
                            "lab_count": 1
                        },
                        "Universidad Estatal de Campinas (UNICAMP)": {
                            "lab_count": 1
                        },
                        "Universidad Federal de Mato Grosso (UFMG)": {
                            "lab_count": 1
                        },
                        "Universidad Federal de Mato Grosso (UFMT)": {
                            "lab_count": 1
                        },
                        "Universidad Federal de Para\u00edba (UFPB)": {
                            "lab_count": 1
                        },
                        "Universidad Federal de Rio Grande do Sur (UFRGS)": {
                            "lab_count": 1
                        },
                        "Universidad Federal de R\u00edo Grande del Sur": {
                            "lab_count": 1
                        },
                        "Universidad Federal de Santa Catarina (UFSC)": {
                            "lab_count": 1
                        },
                        "Universidad Federal de S\u00e3o Carlos (UFSCar)": {
                            "lab_count": 1
                        },
                        "Universidad Federal del Oeste de Bahia (UFOB)": {
                            "lab_count": 1
                        },
                        "Universidad de Blumenau (FURB)": {
                            "lab_count": 1
                        },
                        "Universidade Estadual Paulista (UNESP)/Sagui lab": {
                            "lab_count": 1
                        },
                        "Universidade Federal do Piau\u00ed (UFPI)": {
                            "lab_count": 1
                        },
                        "Universidade Federal do Rio de Janeiro (UFRJ)": {
                            "lab_count": 1
                        }
                    }
                },
                "Pronto3D": {
                    "total_labs": 1,
                    "network_subgroups": {
                        "Universidad Federal de Santa Catarina (UFSC)": {
                            "lab_count": 1
                        }
                    }
                }
            }
        },
        "Gubernamentales": {
            "coords": {
                // *** AJUSTAR MANUALMENTE DESPUÉS DEL PASO 4 ***
                "cx": 300, "cy": 350, "r": 120, "name": "Solo Gubernamentales"
            },
            "affiliation_groups": {
                "None": {
                    "total_labs": 9,
                    "network_subgroups": {
                        "C\u00e1mara de Diputados Federal": {
                            "lab_count": 1
                        },
                        "Ministerio de cuitura": {
                            "lab_count": 1
                        },
                        "Ministerio de cultura": {
                            "lab_count": 1
                        },
                        "Prefectura Jundia\u00ed": {
                            "lab_count": 1
                        },
                        "Prefectura Municipal Araras": {
                            "lab_count": 1
                        },
                        "Prefectura Municipal de Curitiba": {
                            "lab_count": 1
                        },
                        "Prefectura de Santos": {
                            "lab_count": 1
                        },
                        "Secretaria Municipal de Cultura y Econom\u00eda Creativa": {
                            "lab_count": 1
                        },
                        "Secretaria Municipal de Inova\u00e7\u00e3o e Tecnologia": {
                            "lab_count": 1
                        }
                    }
                }
            }
        }
    };
    
    // --- 2. DATOS CALCULADOS PARA VENN.JS ---
    // ESTOS SON LOS TAMAÑOS REALES CALCULADOS DESDE SU JSON (Total: 171)
    const ecosystemData = [
        // Sets puros (Total de labs que caen SÓLO en esa región)
        {sets: ['Civiles'], size: 62, label: 'Civiles', color: '#1b9e77'},
        {sets: ['Educacionales'], size: 26, label: 'Educacionales', color: '#d95f02'},
        {sets: ['Gubernamentales'], size: 9, label: 'Gubernamentales', color: '#7570b3'},
        
        // Intersecciones (Total de labs que caen SÓLO en esa intersección)
        {sets: ['Civiles', 'Educacionales'], size: 31},
        {sets: ['Civiles', 'Gubernamentales'], size: 13},
        {sets: ['Educacionales', 'Gubernamentales'], size: 28},
        
        // Intersección triple
        {sets: ['Civiles', 'Educacionales', 'Gubernamentales'], size: 2}
    ];

    // --- 3. CONFIGURACIÓN DE COLORES ---
    // (Utilizamos un esquema de color para las afiliaciones más grandes y un color por defecto)
    const AFFILIATION_COLORS = {
        "Firjan/SENAI": "#D8234B", 
        "None": "#606060",
        "Escola SESI": "#4B54A3",
        "FAB LAB LIVRE SP": "#1ABC9C",
        "SENAI": "#F39C12",
        // Afiliaciones con un color genérico o un color único si lo deseas
        "Grupo Tiradentes": "#5D6D7E",
        "Movimento +Social Good": "#A569BD",
        "Sistema Federaci\u00f3n de las industrias del Estado de Paran\u00e1 (FIEP)": "#45B39D",
        "Amadomaker": "#F08080",
        "American Spaces": "#A9CCE3",
        "Escola Concept": "#FAD7A0",
        "Fablab Mau\u00e1": "#7DCEA0",
        "Facens": "#5499C7",
        "Pronto3D": "#CD6155",
        "\u00c2nima Lab": "#F4D03F",
        "Enactus": "#85C1E9",
        "IFMaker": "#D2B4DE",
        "Lablivre/Wikilab": "#76D7C4"
        // Asegúrate de añadir cualquier otra afiliación clave
    };

    function getColorByAffiliation(d) {
        return AFFILIATION_COLORS[d.affiliation] || "#888888"; 
    }
    
    const DOT_RADIUS = 3;
    const SPREAD_FACTOR = 0.8; 

    // Función de Posicionamiento Aleatorio (Geometry)
    function getRandomPositionInCircle(centerX, centerY, radius) {
        const angle = Math.random() * 2 * Math.PI;
        // Reduce el radio aleatorio para forzar los puntos hacia el centro (menos ruido en bordes)
        const radius_sq

        <script>
    // --- 1. DATOS DEL USUARIO (JSON) ---
    // (Se mantienen sus datos LAB_STRUCTURE_DATA)
    const LAB_STRUCTURE_DATA = {
        //... (Sus datos JSON de 7 regiones, sin cambios aquí) ...
        "Civiles": {
            "coords": {
                // SUGERENCIA DE AJUSTE: MANTENGA SUS VALORES, PERO SABIENDO QUE SON EL PUNTO CRÍTICO.
                // Los puntos DEBEN estar DENTRO de un radio 'r' desde el centro 'cx, cy'
                "cx": 180, "cy": 180, "r": 60, "name": "Solo Civiles" // Reduje r: 120 a r: 60 para evitar dispersión excesiva
            },
            // ...
        },
        "Civiles/Educacionales": {
            "coords": {
                "cx": 320, "cy": 120, "r": 30, "name": "C \u2229 E" // Reduje r: 60 a r: 30 para intersección
            },
            // ...
        },
        "Civiles/Educacionales/Gubernamentales": {
            "coords": {
                "cx": 300, "cy": 250, "r": 20 // Ajuste central: r: 30 a r: 20
            },
            // ...
        },
        "Civiles/Gubernamentales": {
            "coords": {
                "cx": 250, "cy": 280, "r": 40, "name": "C \u2229 G"
            },
            // ...
        },
        "Educacionales": {
            "coords": {
                "cx": 420, "cy": 180, "r": 60, "name": "Solo Educacionales" // Reduje r: 120 a r: 60
            },
            // ...
        },
        "Educacionales/Gubernamentales": {
            "coords": {
                "cx": 380, "cy": 280, "r": 40, "name": "E \u2229 G"
            },
            // ...
        },
        "Gubernamentales": {
            "coords": {
                "cx": 300, "cy": 350, "r": 60, "name": "Solo Gubernamentales" // Reduje r: 120 a r: 60
            },
            // ...
        }
        //...
    };

    // --- 2. DATOS CALCULADOS PARA VENN.JS ---
    const ecosystemData = [
        {sets: ['Civiles'], size: 62, label: 'Civiles', color: '#1b9e77'},
        {sets: ['Educacionales'], size: 26, label: 'Educacionales', color: '#d95f02'},
        {sets: ['Gubernamentales'], size: 9, label: 'Gubernamentales', color: '#7570b3'},
        
        {sets: ['Civiles', 'Educacionales'], size: 31},
        {sets: ['Civiles', 'Gubernamentales'], size: 13},
        {sets: ['Educacionales', 'Gubernamentales'], size: 28},
        
        {sets: ['Civiles', 'Educacionales', 'Gubernamentales'], size: 2}
    ];

    // --- 3. CONFIGURACIÓN DE COLORES ---
    const AFFILIATION_COLORS = {
        "Firjan/SENAI": "#D8234B", 
        "None": "#606060",
        "Escola SESI": "#4B54A3",
        "FAB LAB LIVRE SP": "#1ABC9C",
        "SENAI": "#F39C12",
        "Grupo Tiradentes": "#5D6D7E",
        "Movimento +Social Good": "#A569BD",
        "Sistema Federación de las industrias del Estado de Paraná (FIEP)": "#45B39D",
        "Amadomaker": "#F08080",
        "American Spaces": "#A9CCE3",
        "Escola Concept": "#FAD7A0",
        "Fablab Mauá": "#7DCEA0",
        "Facens": "#5499C7",
        "Pronto3D": "#CD6155",
        "Ânima Lab": "#F4D03F",
        "Enactus": "#85C1E9",
        "IFMaker": "#D2B4DE",
        "Lablivre/Wikilab": "#76D7C4"
    };

    function getColorByAffiliation(d) {
        return AFFILIATION_COLORS[d.affiliation] || "#888888"; 
    }
    
    const DOT_RADIUS = 3;
    const SPREAD_FACTOR = 0.8; 

    // --- 4. FUNCIONES DE DIBUJO ---

    // Función de Posicionamiento Aleatorio (Geometry)
    function getRandomPositionInCircle(centerX, centerY, radius) {
        // Reducir la dispersión para asegurar que los puntos caigan lejos del borde
        const r = radius * SPREAD_FACTOR; 
        
        const angle = Math.random() * 2 * Math.PI;
        const radius_sq = Math.random() * r * r; 
        const random_radius = Math.sqrt(radius_sq);
        
        const x = centerX + random_radius * Math.cos(angle);
        const y = centerY + random_radius * Math.sin(angle);
        
        return {x, y};
    }

    // A. Dibuja el Diagrama de Venn (Usando venn.js y D3)
    function drawVennDiagram(data, containerId) {
        const chart = venn.VennDiagram()
            .width(600)
            .height(500)
            .styled(false); // Importante: usamos CSS y estilos manuales

        const svg = d3.select(containerId)
            .datum(data)
            .call(chart);
        
        // Aplica el estilo personalizado de etiqueta (label)
        svg.selectAll(".venn-area-label").select("text")
            .style("fill", "white")
            .style("font-size", "14px")
            .style("font-weight", "bold");
        
        return svg;
    }

    // B. Crea y posiciona los puntos
    function drawDots(svgElement) {
        let allDotsData = [];
        let totalDotsCount = 0;
        
        // 1. ITERAR SOBRE CADA REGIÓN DEFINIDA POR USTED
        for (const regionKey in LAB_STRUCTURE_DATA) {
            const region = LAB_STRUCTURE_DATA[regionKey];
            const {cx, cy, r} = region.coords;
            
            // 2. ITERAR SOBRE CADA GRUPO DE AFILIACIÓN DENTRO DE ESA REGIÓN
            for (const affiliation in region.affiliation_groups) {
                const group = region.affiliation_groups[affiliation];
                
                // 3. GENERAR PUNTOS PARA CADA LABORATORIO EN EL GRUPO
                for (let i = 0; i < group.total_labs; i++) {
                    const {x, y} = getRandomPositionInCircle(cx, cy, r);
                    
                    allDotsData.push({
                        id: totalDotsCount++,
                        region: regionKey,
                        affiliation: affiliation,
                        cx: x,
                        cy: y
                    });
                }
            }
        }
        
        // 4. DIBUJAR LOS CÍRCULOS (Puntos)
        svgElement.selectAll(".lab-dot")
            .data(allDotsData)
            .enter()
            .append("circle")
            .attr("class", d => `lab-dot ${d.region.replace(/[\/\s]/g, '_')}`)
            .attr("cx", d => d.cx)
            .attr("cy", d => d.cy)
            .attr("r", DOT_RADIUS)
            .style("fill", d => getColorByAffiliation(d))
            .style("opacity", 0.9)
            .on("mouseover", function(event, d) {
                // Opcional: Implemente un tooltip o efecto hover aquí
                d3.select(this).attr("r", DOT_RADIUS * 1.5).style("stroke", "white").style("stroke-width", 1);
            })
            .on("mouseout", function(event, d) {
                d3.select(this).attr("r", DOT_RADIUS).style("stroke", "none");
            });

        console.log(`Total de ${totalDotsCount} puntos dibujados.`);
    }

    // C. Función principal de ejecución
    function initializeVisualization() {
        // 1. Dibuja el diagrama de Venn (Genera el SVG)
        const svg = drawVennDiagram(ecosystemData, "#venn-diagram-svg-wrapper");
        
        // 2. Espera a que venn.js termine de dibujar la estructura SVG
        // y luego dibuja los puntos en el mismo SVG.
        // Hacemos un pequeño retraso para asegurar que el SVG se haya montado.
        setTimeout(() => {
            drawDots(svg);
        }, 100);
    }

    // 5. LLAMADA DE EJECUCIÓN: Asegura que se ejecuta cuando la página está cargada
    window.onload = initializeVisualization;
    // O mejor:
    // document.addEventListener('DOMContentLoaded', initializeVisualization);
    
</script>
