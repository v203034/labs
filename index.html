<h3 class="map-title">Geolocation & Filters</h3>

<div id="main-container" style="display:flex; width:80%; margin:30px auto; gap:20px;">

    <!-- Panel de filtros -->
    <div id="filter-panel" style="background-color:#ffffff; padding:20px; border-radius:25px; flex:0 0 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <h4 style="color:#373b57; margin-top:0;">Filtros</h4>

        <label for="estado-filter" style="margin-top:15px; display:block;">Estado:</label>
        <select id="estado-filter" style="width:100%; padding:5px; border-radius:5px; border:1px solid #ccc;">
            <option value="">Todos</option>
        </select>

        <label for="ciudad-filter" style="margin-top:15px; display:block;">Ciudad:</label>
        <select id="ciudad-filter" style="width:100%; padding:5px; border-radius:5px; border:1px solid #ccc;">
            <option value="">Todas</option>
        </select>

        <label for="name-filter" style="margin-top:15px; display:block;">Nombre:</label>
        <input type="text" id="name-filter" placeholder="Buscar por nombre" style="width:100%; padding:5px; border-radius:5px; border:1px solid #ccc;">
    </div>

    <!-- Contenedor del mapa -->
    <div id="map-container" style="flex-grow:1; height:600px; border-radius:25px; overflow:hidden;"></div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map = L.map('map-container').setView([-14.2350, -51.9253], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let markers = [];
    let data = [];

    // Cargar datos desde JSON
    fetch("geocoded_iniciativas.json")
    .then(res => res.json())
    .then(jsonData => {
        data = jsonData;

        // Llenar dropdowns
        const estados = [...new Set(data.map(d => d.estado))].sort();
        const ciudades = [...new Set(data.map(d => d.ciudad))].sort();

        const estadoSelect = document.getElementById("estado-filter");
        estados.forEach(e => {
            const option = document.createElement("option");
            option.value = e;
            option.textContent = e;
            estadoSelect.appendChild(option);
        });

        const ciudadSelect = document.getElementById("ciudad-filter");
        ciudades.forEach(c => {
            const option = document.createElement("option");
            option.value = c;
            option.textContent = c;
            ciudadSelect.appendChild(option);
        });

        updateMarkers();
    });

    function updateMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        const estadoVal = document.getElementById("estado-filter").value.toLowerCase();
        const ciudadVal = document.getElementById("ciudad-filter").value.toLowerCase();
        const nameVal = document.getElementById("name-filter").value.toLowerCase();

        const filtered = data.filter(d => 
            (!estadoVal || d.estado.toLowerCase() === estadoVal) &&
            (!ciudadVal || d.ciudad.toLowerCase() === ciudadVal) &&
            (!nameVal || d.name.toLowerCase().includes(nameVal))
        );

        filtered.forEach(d => {
            const marker = L.marker([d.lat, d.lon]).addTo(map);
            marker.bindPopup(`<b>${d.name}</b><br>${d.ciudad}, ${d.estado}`);
            markers.push(marker);
        });

        if (filtered.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.2));
        }
    }

    document.getElementById("estado-filter").addEventListener("change", updateMarkers);
    document.getElementById("ciudad-filter").addEventListener("change", updateMarkers);
    document.getElementById("name-filter").addEventListener("input", updateMarkers);
</script>
